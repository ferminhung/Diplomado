{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Data Factory name",
			"defaultValue": "factoryDiplomado"
		},
		"CosmosDb1_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'CosmosDb1'"
		},
		"blobDiplomado_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'blobDiplomado'"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/default')]",
			"type": "Microsoft.DataFactory/factories/managedVirtualNetworks",
			"apiVersion": "2018-06-01",
			"properties": {
				"preventDataExfiltration": false
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AutoResolveIntegrationRuntime')]",
			"type": "Microsoft.DataFactory/factories/integrationRuntimes",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "Managed",
				"typeProperties": {
					"computeProperties": {
						"location": "AutoResolve",
						"dataFlowProperties": {
							"computeType": "General",
							"coreCount": 8,
							"timeToLive": 0
						}
					}
				},
				"managedVirtualNetwork": {
					"type": "ManagedVirtualNetworkReference",
					"referenceName": "default"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/managedVirtualNetworks/default')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/CosmosDb1')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "CosmosDb",
				"typeProperties": {
					"connectionString": "[parameters('CosmosDb1_connectionString')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/blobDiplomado')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureBlobStorage",
				"typeProperties": {
					"connectionString": "[parameters('blobDiplomado_connectionString')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Bandas')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Bandas criminales a las que pertenecen los presos",
				"linkedServiceName": {
					"referenceName": "blobDiplomado",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Excel",
				"typeProperties": {
					"sheetName": "Hoja1",
					"location": {
						"type": "AzureBlobStorageLocation",
						"fileName": "Descripción (banda criminal).xlsx",
						"container": "datapenitenciaria"
					},
					"firstRowAsHeader": true
				},
				"schema": [
					{
						"name": "Descripción (banda criminal)",
						"type": "String"
					},
					{
						"name": "codigo_interno",
						"type": "String"
					}
				]
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/blobDiplomado')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/CosmosDbSqlApiCollectionDiplomado')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "CosmosDb1",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "CosmosDbSqlApiCollection",
				"schema": {},
				"typeProperties": {
					"collectionName": "Privados"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/CosmosDb1')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Privados')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Datos generales de los presos",
				"linkedServiceName": {
					"referenceName": "blobDiplomado",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Excel",
				"typeProperties": {
					"sheetName": "Hoja1",
					"location": {
						"type": "AzureBlobStorageLocation",
						"fileName": "Consulta amplia.xlsx",
						"container": "datapenitenciaria"
					},
					"firstRowAsHeader": true
				},
				"schema": [
					{
						"name": "codigo_interno",
						"type": "String"
					},
					{
						"name": "region",
						"type": "String"
					},
					{
						"name": "unidad",
						"type": "String"
					},
					{
						"name": "sexo",
						"type": "String"
					},
					{
						"name": "f_nacimiento",
						"type": "String"
					},
					{
						"name": "edad",
						"type": "String"
					},
					{
						"name": "estatura",
						"type": "String"
					},
					{
						"name": "estado_civil",
						"type": "String"
					},
					{
						"name": "hijos_vivos",
						"type": "String"
					},
					{
						"name": "religion",
						"type": "String"
					},
					{
						"name": "nacionalidad",
						"type": "String"
					},
					{
						"name": "etnia",
						"type": "String"
					},
					{
						"name": "lugar_nac",
						"type": "String"
					},
					{
						"name": "tipo_calle",
						"type": "String"
					},
					{
						"name": "direccion",
						"type": "String"
					},
					{
						"name": "tipo_sector",
						"type": "String"
					},
					{
						"name": "sector",
						"type": "String"
					},
					{
						"name": "comuna",
						"type": "String"
					},
					{
						"name": "destino",
						"type": "String"
					},
					{
						"name": "estado_interno",
						"type": "String"
					},
					{
						"name": "lee",
						"type": "String"
					},
					{
						"name": "escribe",
						"type": "String"
					},
					{
						"name": "educacion",
						"type": "String"
					},
					{
						"name": "curso_llego",
						"type": "String"
					},
					{
						"name": "profesion",
						"type": "String"
					},
					{
						"name": "tiempo_minimo",
						"type": "String"
					},
					{
						"name": "f_ini_condena",
						"type": "String"
					},
					{
						"name": "f_fin_condena",
						"type": "String"
					},
					{
						"name": "fecha_reduccion",
						"type": "String"
					},
					{
						"name": "tiempo_total_condena",
						"type": "String"
					},
					{
						"name": "computos_aprobados",
						"type": "String"
					},
					{
						"name": "ultima_conducta",
						"type": "String"
					},
					{
						"name": "fecha_ingreso",
						"type": "String"
					}
				]
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/blobDiplomado')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/PrivadosBandas')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Match de Privados y bandas",
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "Privados",
								"type": "DatasetReference"
							},
							"name": "sourcePrivados"
						},
						{
							"dataset": {
								"referenceName": "Bandas",
								"type": "DatasetReference"
							},
							"name": "sourceBandas"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "CosmosDbSqlApiCollectionDiplomado",
								"type": "DatasetReference"
							},
							"name": "sinkPrivados"
						}
					],
					"transformations": [
						{
							"name": "JoinPrivadosBandas"
						}
					],
					"script": "source(output(\n\t\tcodigo_interno as string,\n\t\tregion as string,\n\t\tunidad as string,\n\t\tsexo as string,\n\t\tf_nacimiento as date,\n\t\tedad as integer,\n\t\testatura as double,\n\t\testado_civil as string,\n\t\thijos_vivos as integer,\n\t\treligion as string,\n\t\tnacionalidad as string,\n\t\tetnia as string,\n\t\tlugar_nac as string,\n\t\ttipo_calle as string,\n\t\tdireccion as string,\n\t\ttipo_sector as string,\n\t\tsector as string,\n\t\tcomuna as string,\n\t\tdestino as string,\n\t\testado_interno as string,\n\t\tlee as string,\n\t\tescribe as string,\n\t\teducacion as string,\n\t\tcurso_llego as string,\n\t\tprofesion as string,\n\t\ttiempo_minimo as string,\n\t\tf_ini_condena as date,\n\t\tf_fin_condena as date,\n\t\tfecha_reduccion as string,\n\t\ttiempo_total_condena as string,\n\t\tcomputos_aprobados as string,\n\t\tultima_conducta as string,\n\t\tfecha_ingreso as date\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tlimit: 100,\n\tignoreNoFilesFound: false) ~> sourcePrivados\nsource(output(\n\t\t{Descripción (banda criminal)} as string,\n\t\tcodigo_interno as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tlimit: 100,\n\tignoreNoFilesFound: false) ~> sourceBandas\nsourcePrivados, sourceBandas join(sourcePrivados@codigo_interno == sourceBandas@codigo_interno,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> JoinPrivadosBandas\nJoinPrivadosBandas sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'document',\n\tpartitionKey: ['/codigo'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1) ~> sinkPrivados"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/Privados')]",
				"[concat(variables('factoryId'), '/datasets/Bandas')]",
				"[concat(variables('factoryId'), '/datasets/CosmosDbSqlApiCollectionDiplomado')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/pipelineDiplomado')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Data flow Diplomado",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "1.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 300,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "PrivadosBandas",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"sourcePrivados": {},
									"sourceBandas": {},
									"sinkPrivados": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					}
				],
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]",
				"[concat(variables('factoryId'), '/dataflows/PrivadosBandas')]"
			]
		}
	]
}